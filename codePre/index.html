<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>codePre</title>
    <style>
      .viewer {
        position: relative;
        width: 100%;
        height: 20px;
      }

      .viewer textarea,
      .viewer iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 96%;
        height: 600px;
      }
      .viewer button {
        position: absolute;
        width: 20%;
      }
    </style>
  </head>
  <body>
    <div class="viewer">
      <button class="codeView">codeView</button>
      <button class="siteView">siteView</button>
    </div>
    <div class="viewer">
      <textarea class="text"></textarea>
      <iframe class="preview"></iframe>
    </div>
  </body>
  <script>
    "use strict";
    const textarea = document.querySelector(".text");
    const siteView = document.querySelector(".siteView");
    const iframe = document.querySelector(".preview");
    const codeView = document.querySelector(".codeView");

    hide(iframe);

    siteView.addEventListener("click", () => {
      iframe.srcdoc = textarea.value;
      show(iframe);
      hide(siteView);
      hide(textarea);
      show(codeView);
    });

    codeView.addEventListener("click", () => {
      hide(iframe);
      show(siteView);
      show(textarea);
      hide(codeView);
    });

    function hide(el) {
      el.style.display = "none";
    }
    function show(el) {
      el.style.display = "block";
    }

    const snippets = {
      // テキスト系
      qp: "<p>|</p>",
      qspan: "<span>|</span>",

      // レイアウト
      qdiv: "<div>|</div>",

      // リスト
      qul: "<ul>\n  |\n</ul>",
      qol: "<ol>\n  |\n</ol>",
      qli: "<li>|</li>",

      // 見出し
      qh1: "<h1>|</h1>",
      qh2: "<h2>|</h2>",
      qh3: "<h3>|</h3>",
      qh4: "<h4>|</h4>",
      qh5: "<h5>|</h5>",
      qh6: "<h6>|</h6>",

      // テーブル
      qtable: "<table>\n  |\n</table>",
      qtr: "<tr>\n  |\n</tr>",
      qth: "<th>|</th>",
      qtd: "<td>|</td>",

      // フォーム
      qform: "<form>|</form>",
      qlabel: '<label for="">|</label>',
      qtextarea: "<textarea>|</textarea>",
      qselect: "<select>\n  |\n</select>",
      qoption: '<option value="">|</option>',
      qbutton: "<button>|</button>",

      qa: '<a href="|"></a>',
      qimg: '<img src="|" alt="">',
      qinput: '<input type="|" />',
      qbr: '<br />',
    };

    textarea.addEventListener("input", function () {
      const value = textarea.value;
      const cursorPos = textarea.selectionStart;
      const beforeCursor = value.slice(0, cursorPos);

      // 末尾の単語を取得
      const match = beforeCursor.match(/q[a-zA-Z0-9]+$/);
      if (!match) return;

      const key = match[0];
      const snippet = snippets[key];
      if (!snippet) return;

      const startPos = cursorPos - key.length;

      // カーソル位置計算用
      const cursorMarkerIndex = snippet.indexOf("|");
      const cleanSnippet = snippet.replace("|", "");

      const newValue =
        value.slice(0, startPos) + cleanSnippet + value.slice(cursorPos);

      textarea.value = newValue;

      const newCursor = startPos + cursorMarkerIndex;
      textarea.selectionStart = textarea.selectionEnd = newCursor;
    });
  </script>
</html>
