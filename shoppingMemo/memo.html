<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>買い物メモ</title>
    <style>


		table {
  			width: 100%;
  			border-collapse: collapse;
  			white-space: nowrap;

		}
		
		table th,
		table td {
  			border: 2px solid #ccc;
  			padding: 15px 10px;
		}


		table td {
		  height: 48px;
  			max-height: 48px;
  			vertical-align: middle;
  			overflow: hidden;
		}


		table input {
  			height: 30px;
  			line-height: 30px;
  			font-size: inherit;
  			box-sizing: border-box;
  			margin: 0;
  			padding: 0 4px;
			background-color: "blue";
		}

		.editing td {
  			position: relative;
		}

		.editing input {
  			position: absolute;
  			inset: 0;
  			width: 100%;
  			height: 100%;
		}

		input{
			font-size: 18px;
		}



    </style>
  </head>

  <body>
    <h2>買い物メモ</h2>

    <form id="form">
      <div class="m1">
        <div class="m2">
          <label
            >商品名 :
            <input type="text" id="name" />
          </label>
          <br />
          <label
            >　値段 : <input type="number" id="amount" min="0" />円
          </label>
          <br />
          <label
            >　個数 : <input type="number" id="quantity" min="0" />枚
          </label>
          <br />
          <label>　備考 : <input type="text" id="kari" /> </label>
          <br />
        </div>
        <button type="submit" id="addbutton">リストに追加</button>
      </div>
    </form>

    <p id="message"></p>

    <div id="target">
      <table id="table">
        <tr>
          <th></th>
          <th>商品名　　　</th>
          <th>値段</th>
          <th>個数</th>
          <th>小計</th>
          <th>備考</th>
          <th></th>
          <th><button id="sakujo">一括削除</button></th>
          <th></th>
        </tr>
      </table>

      <p id="sumAmount">総計: 0円</p>
    </div>
    <button id="capture">リストのダウンロード</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.24/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>

    <script>
      "use strict";

      const table = document.getElementById("table");
      const form = document.getElementById("form");
      const capture = document.getElementById("capture");

      // ローカルストレージから読み込み
      let cardList = JSON.parse(localStorage.getItem("cardList") || "[]");

      function saveToLocalStorage() {
        localStorage.setItem("cardList", JSON.stringify(cardList));
      }

      function updateSum() {
        let sum = 0;
        document.querySelectorAll("tr[data-amount]").forEach((row) => {
          const checkbox = row.querySelector("input[type='checkbox']");
          if (checkbox.checked) sum += Number(row.dataset.amount);
        });
        document.getElementById(
          "sumAmount"
        ).textContent = `総計: ${sum.toLocaleString()}円`;
      }

      // テーブルにカードを表示する
      function addCardToTable(card) {
        const row = table.insertRow();
        row.dataset.id = card.id;
        row.dataset.amount = card.amount * card.quantity;

			const checkCell = row.insertCell();
        const nameCell = row.insertCell();
        const amountCell = row.insertCell();
        const quantityCell = row.insertCell();
        const subtotalCell = row.insertCell();
        const bikouCell = row.insertCell();
        const editCell = row.insertCell();
        const deleteCell = row.insertCell();
        const handleCell = row.insertCell();

// チェックボックス
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = true;
        checkbox.addEventListener("change", updateSum);

        nameCell.textContent = card.name;
        amountCell.textContent = card.amount.toLocaleString();
        quantityCell.textContent = card.quantity;
        subtotalCell.textContent = (
          card.amount * card.quantity
        ).toLocaleString();

        
        checkCell.appendChild(checkbox);

        // 備考
        bikouCell.textContent = card.bikou;

        // 編集ボタン
        const editBtn = document.createElement("button");
        editBtn.textContent = "編集";
        editCell.appendChild(editBtn);

        // 削除ボタン
        const delBtn = document.createElement("button");
        delBtn.textContent = " × ";
        deleteCell.appendChild(delBtn);

        //並び替えバー
        handleCell.textContent = "≡";
        handleCell.className = "handle";
        
        // 編集機能
        let editing = false;
        editBtn.addEventListener("click", () => {
          if (!editing) {
            row.classList.add("editing");
            nameCell.innerHTML = `<input type="text" value="${nameCell.textContent}">`;
            amountCell.innerHTML = `<input type="number" min="0" value="${amountCell.textContent.replace(
              /,/g,
              ""
            )}" class="amount">`;
            quantityCell.innerHTML = `<input type="number" min="1" value="${quantityCell.textContent}" class="quantity">`;
            bikouCell.innerHTML = `<input type="text" value="${bikouCell.textContent}">`;
            editBtn.textContent = "保存";
            editing = true;
          } else {
            const newName = nameCell.querySelector("input").value.trim();
            const newAmountStr = amountCell.querySelector("input").value.trim(); // ←これが必要
            const newQuantityStr = quantityCell
              .querySelector("input")
              .value.trim();
            const newBikou = bikouCell.querySelector("input").value.trim();

            const newAmount = Number(newAmountStr);
            const newQuantity = Number(newQuantityStr);

            if (newName === "") {
              message.textContent = "商品名が空です";
              return;
            }
            if (newAmountStr === "") {
              message.textContent = "値段が未入力です";
              return;
            }
            if (newQuantityStr === "") {
              message.textContent = "個数が未入力です";
              return;
            }

            nameCell.textContent = newName;
            amountCell.textContent = newAmount.toLocaleString();
            quantityCell.textContent = newQuantity;
            subtotalCell.textContent = (
              newAmount * newQuantity
            ).toLocaleString();
            bikouCell.textContent = newBikou;

            // 配列の更新
            const index = cardList.findIndex((c) => c.id === card.id);
            cardList[index] = {
              id: card.id,
              name: newName,
              amount: newAmount,
              quantity: newQuantity,
              bikou: newBikou,
            };
            saveToLocalStorage();

            row.dataset.amount = newAmount * newQuantity;
            editBtn.textContent = "編集";
            editing = false;
            row.classList.remove("editing");
            updateSum();
          }
        });

        // 削除
        delBtn.addEventListener("click", () => {
          if (confirm(`リストから”${card.name}”を削除してもよろしいですか？`)) {
            row.remove();
            cardList = cardList.filter((c) => c.id !== card.id);
            saveToLocalStorage();
            updateSum();
          }
        });

        updateSum();
      }

      // ページ再読み込み
      cardList.forEach(addCardToTable);

      // フォーム送信時の処理
      form.onsubmit = (event) => {
        event.preventDefault();

        const nameInput = document.getElementById("name");
        const amountInput = document.getElementById("amount");
        const quantityInput = document.getElementById("quantity");
        const bikouInput = document.getElementById("kari");
        const message = document.getElementById("message");

        const name = nameInput.value.trim();
        const amount = Number(amountInput.value.trim());
        const quantity = Number(quantityInput.value.trim());
        const bikou = bikouInput.value.trim();

        if (name === "") {
          message.textContent = "商品名が入力されていません。";
          return;
        }
        if (Number.isNaN(amount) || amount < 0) {
          message.textContent = "値段は0円以上で入力してください。";
          return;
        }
        if (!Number.isInteger(quantity) || quantity < 0) {
          message.textContent = "個数は0以上で入力してください。";
          return;
        }

        message.textContent = "";

        const newCard = { id: Date.now(), name, amount, quantity, bikou };
        cardList.push(newCard);
        saveToLocalStorage();
        addCardToTable(newCard);
        form.reset();
      };

      //スクリーンショット
      capture.addEventListener("click", () => {
        if (window.confirm(`リストをダウンロードしますか？(png)`)) {
          const fileName =
            prompt("ファイル名を入力してください", "list") || "list";
          const target = document.getElementById("target");
          html2canvas(target).then((canvas) => {
            const link = document.createElement("a");
            link.download = `${fileName}.png`;
            link.href = canvas.toDataURL();
            link.click();
            // alert(`”${link.download}”をダウンロードしました`);
          });
        }
      });

      //並び替え
      $(function () {
        $("#table").sortable({
          items: "tr:not(tr:first-child)",
          handle: ".handle",
          axis: "y",
          stop: function () {
            const oldList = [...cardList];
            const newList = [];

            $("#table tr[data-id]").each(function () {
              const id = Number(this.dataset.id);
              const card = oldList.find((c) => c.id === id);
              if (card) newList.push(card);
            });

            cardList = newList;
            saveToLocalStorage();
          },
        });
      });

		const sakujo = document.getElementById("sakujo");

function allClear() {
  if (!confirm("リストをすべて削除しますか？")) return;

  // データ削除
  localStorage.removeItem("cardList");
  cardList = [];

  // テーブルの行を削除（1行目はヘッダーなので残す）
  while (table.rows.length > 1) {
    table.deleteRow(1);
  }

  updateSum();
}

sakujo.addEventListener("click", allClear);


		
    </script>
  </body>
</html>
